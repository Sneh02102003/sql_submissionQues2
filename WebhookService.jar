@Service
public class WebhookService {

    private final RestTemplate restTemplate = new RestTemplate();

    public void startFlow() {
       
        String url = "https://bfhldevapigw.healthrx.co.in/hiring/generateWebhook/JAVA";

        Map<String, String> body = Map.of(
            "name", "Sneh Gandhi",
            "regNo", "22BCI0120",   
            "email", "sneh.gandhi2022@vitstudent.ac.in"
        );

        ResponseEntity<Map> response = restTemplate.postForEntity(url, body, Map.class);

        String webhookUrl = (String) response.getBody().get("webhook");
        String accessToken = (String) response.getBody().get("accessToken");

        
        String finalQuery = "SELECT e1.EMP_ID, e1.FIRST_NAME, e1.LAST_NAME, d.DEPARTMENT_NAME, " +
                            "COUNT(e2.EMP_ID) AS YOUNGER_EMPLOYEES_COUNT " +
                            "FROM EMPLOYEE e1 " +
                            "JOIN DEPARTMENT d ON e1.DEPARTMENT = d.DEPARTMENT_ID " +
                            "LEFT JOIN EMPLOYEE e2 ON e1.DEPARTMENT = e2.DEPARTMENT AND e2.DOB > e1.DOB " +
                            "GROUP BY e1.EMP_ID, e1.FIRST_NAME, e1.LAST_NAME, d.DEPARTMENT_NAME " +
                            "ORDER BY e1.EMP_ID DESC;";

 
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        headers.setBearerAuth(accessToken);

        Map<String, String> payload = Map.of("finalQuery", finalQuery);

        HttpEntity<Map<String, String>> entity = new HttpEntity<>(payload, headers);

        ResponseEntity<String> submissionResponse = restTemplate.postForEntity(webhookUrl, entity, String.class);

        System.out.println("Submission Response: " + submissionResponse.getBody());
    }
}
